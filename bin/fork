#!/bin/bash

source $(dirname $0)/common/init
source $(dirname $0)/common/create_repo

while getopts ':' flag; do
    case "${flag}" in
        *) error "Unexpected option ${flag}" ;;
    esac
done

if [[ $# -ne 1 ]]
then
    error "Expecting exactly one argument"
    exit 1
fi
ORIGIN_URL=UPSTREAM=$1
source $(dirname $0)/common/origin
source $(dirname $0)/common/github
REPO_NAME=$(echo $ORIGIN | sed -Ene 's/^([-a-zA-Z]*)\/([-a-zA-Z\._]*)/\2/pg')

create_fork $ORIGIN
git clone --origin upstream $UPSTREAM
GITHUB_USER=$(curl -H "Authorization: token $(<$GITHUB_TOKEN)"
    $GITHUB_API/user
    2>/dev/null
    | jq -r .login
)

cd $REPO_NAME

DOWNSTREAM=$GITHUB_USER/$REPO_NAME
git remote add origin $DOWNSTREAM
